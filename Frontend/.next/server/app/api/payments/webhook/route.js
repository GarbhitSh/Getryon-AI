"use strict";(()=>{var e={};e.id=4,e.ids=[4],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},14300:e=>{e.exports=require("buffer")},32081:e=>{e.exports=require("child_process")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},41808:e=>{e.exports=require("net")},85477:e=>{e.exports=require("punycode")},12781:e=>{e.exports=require("stream")},24404:e=>{e.exports=require("tls")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},4126:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>w,requestAsyncStorage:()=>g,routeModule:()=>b,serverHooks:()=>_,staticGenerationAsyncStorage:()=>h});var s={};t.r(s),t.d(s,{POST:()=>d});var o=t(49303),i=t(88716),n=t(60670),a=t(47690),u=t(71615),c=t(87070);let p=new(t(48472)).Z(process.env.STRIPE_SECRET_KEY);async function d(e){let r=(0,u.cookies)(),t=(0,a.lx)(process.env.SUPABASE_URL,process.env.SUPABASE_SERVICE_KEY,{cookies:{get:e=>r.get(e)?.value}});return f(await e.text(),e,t)}async function l(e){try{return(await p.customers.retrieve(e)).email}catch(e){return console.error("Error fetching customer:",e),null}}async function m(e,r,t){let s,o;let i=e.data.object,n=await l(i.customer);if(!n)return c.NextResponse.json({status:500,error:"Customer email could not be fetched"});let a={subscription_id:i.id,stripe_user_id:i.customer,status:i.status,start_date:new Date(1e3*i.created).toISOString(),plan_id:i.items.data[0]?.price.id,user_id:i.metadata?.userId||"",email:n};if("deleted"===r){if({data:s,error:o}=await t.from("subscriptions").update({status:"cancelled",email:n}).match({subscription_id:i.id}).select(),!o){let{error:e}=await t.from("user").update({subscription:null}).eq("email",n);if(e)return console.error("Error updating user subscription status:",e),c.NextResponse.json({status:500,error:"Error updating user subscription status"})}}else({data:s,error:o}=await t.from("subscriptions")["created"===r?"insert":"update"]("created"===r?[a]:a).match({subscription_id:i.id}).select());return o?(console.error(`Error during subscription ${r}:`,o),c.NextResponse.json({status:500,error:`Error during subscription ${r}`})):c.NextResponse.json({status:200,message:`Subscription ${r} success`,data:s})}async function x(e,r,t){let s=e.data.object,o=await l(s.customer);if(!o)return c.NextResponse.json({status:500,error:"Customer email could not be fetched"});let i={invoice_id:s.id,subscription_id:s.subscription,amount_paid:"succeeded"===r?s.amount_paid/100:void 0,amount_due:"failed"===r?s.amount_due/100:void 0,currency:s.currency,status:r,user_id:s.metadata?.userId,email:o},{data:n,error:a}=await t.from("invoices").insert([i]);return a?(console.error(`Error inserting invoice (payment ${r}):`,a),c.NextResponse.json({status:500,error:`Error inserting invoice (payment ${r})`})):c.NextResponse.json({status:200,message:`Invoice payment ${r}`,data:n})}async function y(e,r){let t=e.data.object,s=t?.metadata;if(s?.subscription==="true"){let e=t.subscription;try{await p.subscriptions.update(e,{metadata:s});let{error:o}=await r.from("invoices").update({user_id:s?.userId}).eq("email",s?.email);if(o)throw Error("Error updating invoice");let{error:i}=await r.from("user").update({subscription:t.id}).eq("user_id",s?.userId);if(i)throw Error("Error updating user subscription");return c.NextResponse.json({status:200,message:"Subscription metadata updated successfully"})}catch(e){return console.error("Error updating subscription metadata:",e),c.NextResponse.json({status:500,error:"Error updating subscription metadata"})}}else{let e=new Date(1e3*t.created).toISOString();try{let{data:o,error:i}=await r.from("user").select("*").eq("user_id",s?.userId);if(i)throw Error("Error fetching user");let n={user_id:s?.userId,stripe_id:t.id,email:s?.email,amount:t.amount_total/100,customer_details:JSON.stringify(t.customer_details),payment_intent:t.payment_intent,payment_time:e,currency:t.currency},{data:a,error:u}=await r.from("payments").insert([n]);if(u)throw Error("Error inserting payment");let p=Number(o?.[0]?.credits||0)+(t.amount_total||0)/100,{data:d,error:l}=await r.from("user").update({credits:p}).eq("user_id",s?.userId);if(l)throw Error("Error updating user credits");return c.NextResponse.json({status:200,message:"Payment and credits updated successfully",updatedUser:d})}catch(e){return console.error("Error handling checkout session:",e),c.NextResponse.json({status:500,error:e})}}}async function f(e,r,t){let s=r.headers.get("Stripe-Signature");try{let r=await p.webhooks.constructEventAsync(e,s,process.env.STRIPE_WEBHOOK_SECRET);switch(r.type){case"customer.subscription.created":return m(r,"created",t);case"customer.subscription.updated":return m(r,"updated",t);case"customer.subscription.deleted":return m(r,"deleted",t);case"invoice.payment_succeeded":return x(r,"succeeded",t);case"invoice.payment_failed":return x(r,"failed",t);case"checkout.session.completed":return y(r,t);default:return c.NextResponse.json({status:400,error:"Unhandled event type"})}}catch(e){return console.error("Error constructing Stripe event:",e),c.NextResponse.json({status:500,error:"Webhook Error: Invalid Signature"})}}let b=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/payments/webhook/route",pathname:"/api/payments/webhook",filename:"route",bundlePath:"app/api/payments/webhook/route"},resolvedPagePath:"D:\\instatryon\\InstaTryOn.ai\\app\\api\\payments\\webhook\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:h,serverHooks:_}=b,E="/api/payments/webhook/route";function w(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:h})}},49303:(e,r,t)=>{e.exports=t(30517)}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[948,70,385,690,472],()=>t(4126));module.exports=s})();